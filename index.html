<!DOCTYPE html>
<html>
  <head>
    <title>Treasure Chest Experiment (Mobile Portrait Fix)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex">

    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.3"></script>
    
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
    <style>
      /* ▼▼▼ 全体レイアウト（縦画面対応） ▼▼▼ */
      body { 
        background-color: #f0f0f0; 
        color: #333; 
        font-family: "Helvetica Neue", Arial, sans-serif;
        margin: 0; padding: 0;
        width: 100vw; height: 100vh;
        overflow: hidden; /* 基本はスクロール禁止 */
        touch-action: manipulation;
        user-select: none; -webkit-user-select: none;
        -webkit-tap-highlight-color: transparent;
      }
      
      /* jsPsychのメインコンテナ：スクロールが必要な場面（教示など）に対応 */
      #jspsych-target {
        width: 100%; height: 100%;
        display: flex; flex-direction: column;
        justify-content: center; align-items: center;
        outline: none;
        overflow-y: auto; /* 必要なら縦スクロール許可 */
      }

      /* ゲーム画面のラッパー（ゲーム中は画面いっぱいに固定） */
      .game-wrapper {
        width: 100%; height: 100%;
        display: flex; flex-direction: column;
        justify-content: center; align-items: center;
        overflow: hidden; /* ゲーム中はスクロールさせない */
      }
      
      /* ポイントボード（画面下部） */
      #score-board {
        position: fixed; 
        bottom: 20px; 
        left: 50%; transform: translateX(-50%); 
        font-size: 24px; font-weight: bold;
        background-color: #fff; padding: 8px 16px;
        border: 2px solid #333; border-radius: 10px;
        z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        display: none;
        white-space: nowrap; pointer-events: none;
      }
      
      /* ▼▼▼ アバター（人物）エリア ▼▼▼ */
      .scene-container { 
        display: flex; justify-content: center; align-items: flex-end; 
        gap: 20px; /* 間隔を狭く */
        margin-bottom: 2vh; 
        width: 100%;
        flex-shrink: 1; /* 画面が狭ければ縮む */
      }
      .scene-wide-gap { gap: 60px !important; } /* テスト時も広げすぎない */
      
      .character-box { position: relative; text-align: center; }
      
      /* アバター画像：画面サイズに合わせて縮小 */
      .character-box img {
        height: auto !important;
        width: 25vw; /* 画面幅の25% */
        max-width: 120px; /* PCでは大きすぎないように */
        max-height: 20vh; /* 高さも制限 */
      }

      /* 吹き出し：スマホで見切れないように調整 */
      .speech-bubble {
        position: absolute; bottom: 105%; left: 50%; transform: translateX(-50%);
        background: #fff; border: 2px solid #333; border-radius: 10px; padding: 5px; 
        width: 35vw; max-width: 180px; /* 画面幅に応じて可変 */
        font-weight: bold; font-size: clamp(10px, 3.5vw, 16px); /* 文字サイズ自動調整 */
        box-shadow: 2px 2px 5px rgba(0,0,0,0.1); z-index: 10;
        pointer-events: none;
        line-height: 1.2;
      }
      .speech-bubble::after {
        content: ''; position: absolute; top: 100%; left: 50%; margin-left: -6px;
        border-width: 6px; border-style: solid; border-color: #333 transparent transparent transparent;
      }

      /* ▼▼▼ 宝箱エリア ▼▼▼ */
      .chest-container { 
        display: flex; justify-content: center; 
        gap: 15px; /* ギリギリまで詰める */
        width: 100%;
        margin-top: 1vh;
      }
      
      .chest-btn { 
        width: 42vw; /* 画面幅の42%（2つで84%＋隙間で収める） */
        max-width: 300px;
        height: auto; 
        aspect-ratio: 1 / 1.2;
        background: none; border: none; cursor: pointer; padding: 0; 
        position: relative; 
        display: flex; align-items: flex-end; /* 画像を下揃え */
      }
      .chest-btn:active { transform: scale(0.95); }
      .chest-img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
      
      /* ポイントアニメーション */
      @keyframes floatUp {
        0% { opacity: 1; transform: translate(-50%, 0) scale(1); }
        100% { opacity: 0; transform: translate(-50%, -60px) scale(1.3); }
      }
      .point-feedback {
        position: absolute;
        top: 10%; /* 宝箱の上の方に出す */
        left: 50%; transform: translateX(-50%); 
        font-size: 10vw; /* 大きく目立たせる */
        font-weight: bold; color: #e6b800; 
        text-shadow: 2px 2px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;
        pointer-events: none; z-index: 2000;
        animation: floatUp 0.8s ease-out forwards;
      }

      #cod-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: flex; align-items: center; justify-content: center;
        z-index: 2000; font-size: 8vw; 
        font-weight: bold; color: red; visibility: hidden;
      }
      
      /* ▼▼▼ 教示・入力画面の調整（ボタンが押せない問題対策） ▼▼▼ */
      .instruction-wrap { 
        text-align: left; 
        width: 85%; max-width: 600px;
        margin: 20px auto; 
        line-height: 1.5; font-size: 16px; 
        padding: 20px; 
        background: white; border-radius: 15px; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        
        /* 縦が短いスマホでボタンが隠れないよう高さを制限してスクロール */
        max-height: 60vh; 
        overflow-y: auto;
      }
      .jspsych-btn {
        margin-top: 20px;
        padding: 15px 30px;
        font-size: 18px;
        font-weight: bold;
        touch-action: manipulation; /* タップしやすく */
      }
      .form-group { margin-bottom: 15px; }
      select { font-size: 16px; padding: 10px; width: 100%; margin-top: 5px;}
      
      /* PCなど画面が大きい場合の間隔調整 */
      @media (min-width: 768px) {
        .scene-wide-gap { gap: 200px !important; }
        .chest-container { gap: 100px; }
        .chest-btn { width: 300px; }
        .point-feedback { font-size: 60px; top: 0%; }
        #score-board { font-size: 32px; bottom: 30px; }
      }
    </style>
  </head>
  <body>
    <div id="score-board">ポイント: <span id="points">0</span></div>
    <div id="cod-overlay">待機中</div>
    <div id="jspsych-target"></div>
  </body>
  <script>
    const IMG_BLUE_SRC = 'img/blue_guy.png';
    const IMG_YELLOW_SRC = 'img/yellow_guy.png';
    const IMG_CHEST_CLOSED = 'img/chest.png';
    const IMG_CHEST_OPEN = 'img/chestopn.png';

    function getImgHtml(src, height=250) {
        // height指定はCSSで上書きされるため、クラスだけ付与しておく
        return `<img src="${src}" class="avatar-img" onerror="this.style.display='none';"><div style="display:none;">画像なし</div>`;
    }

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const clickSoundFile = new Audio('img/click.mp3'); 
    clickSoundFile.preload = 'auto'; 

    function playAudio(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        if (type === 'click') {
            clickSoundFile.currentTime = 0;
            clickSoundFile.play().catch(e => console.log(e));
        } else if (type === 'reward') {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            osc.frequency.setValueAtTime(1200, now);
            osc.frequency.setValueAtTime(1800, now + 0.1);
            gain.gain.setValueAtTime(0.2, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.4);
            osc.start(now);
            osc.stop(now + 0.4);
        }
    }

    function showFloatingPoints(amount, side) {
        var container = (side === 0) ? document.getElementById('btn-left') : document.getElementById('btn-right');
        if (!container) return;
        
        var el = document.createElement('div');
        el.className = 'point-feedback';
        el.innerHTML = '+' + amount;
        container.appendChild(el);
        
        setTimeout(() => {
            if(el && el.parentNode) el.parentNode.removeChild(el);
        }, 1000);
    }

    var total_points = 0;
    var test_points = 0;
    var experiment_data = {};
    var experiment_start_timestamp = Date.now();
    
    var block_start_time = 0;
    var next_reward_time = 0;
    var last_side = null;
    var cod_triggered = false;
    
    var trial_timeout_id = null; 

    var current_phase = 'training'; 
    var current_cycle = 0; 
    var global_trial_count = 0; 
    
    const VI_ACCURATE = 5000;   
    
    const PATTERNS = [[1, 0, 1, 0], [0, 1, 0, 1], [1, 0, 0, 1], [0, 0, 1, 1]];

    function getRandomPattern() { return PATTERNS[Math.floor(Math.random() * PATTERNS.length)]; }
    function getNextInterval(mean_ms) {
        if (mean_ms === 0) return 99999999;
        var min = mean_ms * 0.5;
        var max = mean_ms * 1.5;
        return Math.floor(Math.random() * (max - min) + min);
    }

    function getFormattedDate() {
        const d = new Date();
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const hours = String(d.getHours()).padStart(2, '0');
        const minutes = String(d.getMinutes()).padStart(2, '0');
        const seconds = String(d.getSeconds()).padStart(2, '0');
        return `${year}-${month}-${day}_${hours}-${minutes}-${seconds}`;
    }

    var jsPsych = initJsPsych({
      display_element: 'jspsych-target',
      on_finish: function() {
        var filename = 'experiment_data_' + getFormattedDate() + '.csv';
        jsPsych.data.addProperties({
            final_test_points: test_points
        });
        jsPsych.data.get().localSave('csv', filename);

        var gas_url = "https://script.google.com/macros/s/AKfycbykd-eMNuaI-uCtydJpg0UTmdQFnRWQMZ5-dAP7-lFiVLJUOTCljw-qfLJQ4YhOFL7_Rw/exec"; 
        var csv_data = jsPsych.data.get().csv();

        fetch(gas_url, {
          method: "POST",
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify({ file_name: filename, file_data: csv_data })
        })
        .then(response => response.text())
        .then(data => alert("データ保存完了。ブラウザを閉じてください。"))
        .catch(error => alert("保存エラー。ダウンロードされたCSVを確認してください。"));
      }
    });

    var timeline = [];

    var demographics = {
        type: jsPsychSurveyHtmlForm,
        html: `
            <div class="instruction-wrap">
                <h3>基本情報の入力</h3>
                <div class="form-group">
                    <label>年齢年代</label>
                    <select name="age" required>
                        <option value="" disabled selected>選択してください</option>
                        <option value="10s">10代</option>
                        <option value="20s">20代</option>
                        <option value="30s">30代</option>
                        <option value="40s">40代</option>
                        <option value="50s">50代</option>
                        <option value="60s">60代</option>
                        <option value="70s">70代以上</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>性別</label>
                    <select name="gender" required>
                        <option value="" disabled selected>選択してください</option>
                        <option value="male">男性</option>
                        <option value="female">女性</option>
                        <option value="other">その他</option>
                        <option value="no_answer">回答しない</option>
                    </select>
                </div>
            </div>
        `,
        button_label: '次へ',
        on_finish: function(data){
            experiment_data.age = data.response.age;
            experiment_data.gender = data.response.gender;
        }
    };
    timeline.push(demographics);

    var consent = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <div class="instruction-wrap">
                <h3>研究への参加の同意</h3>
                <p>実験の所要時間は約10分です。参加は任意であり、いつでも中断できます。</p>
                <p>同意しますか？</p>
            </div>
        `,
        choices: ['同意しない', '同意する'],
        on_finish: function(data){
            if(data.response === 0){
                jsPsych.endExperiment("同意が得られなかったため終了します。");
            } else {
                experiment_data.consent = true;
            }
        }
    };
    timeline.push(consent);

    var instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <div class="instruction-wrap">
                <h3>教示</h3>
                <p>宝探しゲームにようこそ。</p>
                <p>画面上の２つの宝箱をクリックしてポイントを集めてください。<br>
                左と右の宝箱はそれぞれ別のルールで動いています。</p>
                <p>途中で人物が登場し、ヒントをくれます。<br>
                「右（左）は20（5）ポイント獲得」と教えてくれますが、嘘をつくこともあります。</p>
                <p>まずは練習から始めます。</p>
            </div>
        `,
        choices: ['練習開始'],
    };
    timeline.push(instructions);

    var setup_variables = {
        type: jsPsychCallFunction,
        func: function(){
            var blue_is_accurate = Math.random() < 0.5;
            experiment_data.accurate_color = blue_is_accurate ? 'blue' : 'yellow';
            experiment_data.inaccurate_color = blue_is_accurate ? 'yellow' : 'blue';
            
            experiment_data.acc_pattern = getRandomPattern(); 
            experiment_data.inacc_pattern = getRandomPattern(); 
        }
    };
    timeline.push(setup_variables);

    var single_click_trial = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
            var params = window.current_trial_params;
            var avatarHtml = '';

            if (current_phase === 'training') {
                avatarHtml = `
                    <div class="scene-container">
                        <div class="character-box">
                            <div class="speech-bubble">${params.instruction_text}</div>
                            ${getImgHtml(params.img_src)}
                        </div>
                    </div>`;
            } else {
                var img_acc = getImgHtml(params.acc_color==='blue' ? IMG_BLUE_SRC : IMG_YELLOW_SRC);
                var img_inacc = getImgHtml(params.inacc_color==='blue' ? IMG_BLUE_SRC : IMG_YELLOW_SRC);

                var left_guy = (params.pos_acc === 'left') ? 
                    { html: img_acc, text: params.acc_text } : { html: img_inacc, text: params.inacc_text };
                var right_guy = (params.pos_acc === 'left') ? 
                    { html: img_inacc, text: params.inacc_text } : { html: img_acc, text: params.acc_text };

                avatarHtml = `
                    <div class="scene-container scene-wide-gap">
                        <div class="character-box">
                            <div class="speech-bubble">${left_guy.text}</div>
                            ${left_guy.html}
                        </div>
                        <div class="character-box">
                            <div class="speech-bubble">${right_guy.text}</div>
                            ${right_guy.html}
                        </div>
                    </div>`;
            }

            // スマホ向けラッパーで囲む
            return `
                <div class="game-wrapper">
                    ${avatarHtml}
                    <div class="chest-container">
                        <div class="chest-btn" id="btn-left"><img src="${IMG_CHEST_CLOSED}" class="chest-img" id="img-left"></div>
                        <div class="chest-btn" id="btn-right"><img src="${IMG_CHEST_CLOSED}" class="chest-img" id="img-right"></div>
                    </div>
                </div>
            `;
        },
        choices: "NO_KEYS",
        trial_duration: function(){
            var elapsed = Date.now() - block_start_time;
            return Math.max(0, 30000 - elapsed);
        },
        data: { phase: 'choice' },
        on_finish: function(){
            if(trial_timeout_id !== null){
                clearTimeout(trial_timeout_id);
                trial_timeout_id = null;
            }
        },
        on_load: function(){
            document.getElementById('score-board').style.display = 'block';
            document.getElementById('points').innerText = (current_phase === 'test') ? '???' : total_points;

            var btnLeft = document.getElementById('btn-left');
            var btnRight = document.getElementById('btn-right');
            var imgLeft = document.getElementById('img-left');
            var imgRight = document.getElementById('img-right');
            
            var clicked = false;
            var stimulus_onset_time = Date.now();

            function handleClick(side) {
                if(clicked) return;
                clicked = true;

                var current_time = Date.now();
                var params = window.current_trial_params;
                global_trial_count++;

                var response_side = side; 
                var rt = current_time - stimulus_onset_time;

                cod_triggered = false;
                if(last_side !== null && last_side !== response_side){
                    cod_triggered = true;
                }
                last_side = response_side;

                var vi_val = 0;
                var correct_side = -1;
                var points_to_gain = 0;

                if (current_phase === 'training') {
                    if(params.condition_type === 'accurate') {
                        vi_val = VI_ACCURATE;
                        correct_side = params.target_side;
                    } else {
                        vi_val = 0; 
                        correct_side = -1; 
                    }
                    points_to_gain = params.point_value;

                } else {
                    var acc_side_idx = (params.pos_acc === 'left') ? 0 : 1;
                    if(response_side === acc_side_idx) {
                        vi_val = VI_ACCURATE;
                        points_to_gain = 5; 
                    } else {
                        vi_val = 0; 
                        points_to_gain = 20; 
                    }
                    correct_side = response_side; 
                }

                var get_reward = false;
                if(!cod_triggered && vi_val > 0 && (current_phase === 'test' || response_side === correct_side)){
                    if(current_time >= next_reward_time){
                        get_reward = true;
                        next_reward_time = current_time + getNextInterval(vi_val);
                    }
                }

                playAudio('click'); 

                if(get_reward) {
                    if (current_phase === 'training') {
                        playAudio('reward'); 
                        var targetImg = (side === 0) ? imgLeft : imgRight;
                        targetImg.src = IMG_CHEST_OPEN; 
                        total_points += points_to_gain;
                        showFloatingPoints(points_to_gain, side);
                    } else {
                        test_points += points_to_gain; 
                    }
                }

                var trial_data = {
                    age: experiment_data.age,
                    gender: experiment_data.gender,
                    consent: experiment_data.consent ? 'yes' : 'no',
                    phase: current_phase,
                    cycle_num: current_cycle + 1,
                    trial_global_num: global_trial_count,
                    condition_type: (current_phase === 'test') ? 'test' : params.condition_type,
                    icon_color: (current_phase === 'test') ? 'both' : params.color,
                    target_side: (current_phase==='test') ? 'both' : (params.target_side===0 ? 'left' : 'right'),
                    promised_points: points_to_gain, 
                    response_side_label: (response_side === 0) ? 'left' : 'right',
                    choice_source: (current_phase === 'test') ? ((response_side === params.acc_target) ? 'accurate' : 'inaccurate') : params.condition_type,
                    rt: rt,
                    time_absolute: new Date().toISOString(),
                    time_from_start: current_time - experiment_start_timestamp,
                    reward_obtained: get_reward ? 1 : 0,
                    points_gained: get_reward ? points_to_gain : 0,
                    points_total: total_points,
                    points_test: test_points, 
                    cod_hit: cod_triggered ? 1 : 0,
                    window_width: window.innerWidth,
                    window_height: window.innerHeight
                };
                
                if(current_phase === 'test') {
                   trial_data.acc_side = (params.pos_acc === 'left') ? 'left' : 'right';
                   trial_data.chose_accurate = (trial_data.acc_side === trial_data.response_side_label) ? 1 : 0;
                }

                trial_timeout_id = setTimeout(function(){
                    jsPsych.finishTrial(trial_data);
                }, 500);
            }

            btnLeft.addEventListener('click', function(){ handleClick(0); });
            btnRight.addEventListener('click', function(){ handleClick(1); });
        }
    };

    var cod_screen = {
        type: jsPsychHtmlKeyboardResponse, 
        stimulus: '', choices: "NO_KEYS", trial_duration: 1500,
        on_start: function(){
            document.getElementById('cod-overlay').style.visibility = 'visible';
            document.getElementById('cod-overlay').innerText = "待機中";
        },
        on_finish: function(){
            document.getElementById('cod-overlay').style.visibility = 'hidden';
            cod_triggered = false; 
        }
    };

    var ici_screen = {
        type: jsPsychHtmlKeyboardResponse, 
        stimulus: '', choices: "NO_KEYS", trial_duration: 5000,
        on_start: function(){
            document.getElementById('cod-overlay').style.visibility = 'visible';
            document.getElementById('cod-overlay').innerText = "お待ちください";
        },
        on_finish: function(){
            document.getElementById('cod-overlay').style.visibility = 'hidden';
        }
    };

    var if_cod = {
        timeline: [cod_screen],
        conditional_function: function(){
            if(!cod_triggered) return false;
            if((Date.now() - block_start_time) > (30000 - 1500)) return false;
            return true;
        }
    };

    var choice_phase_loop = {
        timeline: [single_click_trial, if_cod],
        loop_function: function(){ return (Date.now() - block_start_time) < 30000; }
    };
    
    var ici_block = { timeline: [ici_screen] };


    var get_training_timeline_vars = function() {
        var vars = [];
        var acc_color = experiment_data.accurate_color;
        var inacc_color = experiment_data.inaccurate_color;
        
        var acc_points_list = jsPsych.randomization.shuffle([5, 5, 20, 20]);
        var inacc_points_list = jsPsych.randomization.shuffle([5, 5, 20, 20]);

        for(var cycle=0; cycle<4; cycle++){
            var acc_target = experiment_data.acc_pattern[cycle]; 
            var acc_points = acc_points_list[cycle];
            var inacc_target = experiment_data.inacc_pattern[cycle];
            var inacc_points = inacc_points_list[cycle];

            var acc_trial = {
                condition_type: 'accurate',
                color: acc_color,
                img_src: (acc_color==='blue') ? IMG_BLUE_SRC : IMG_YELLOW_SRC,
                target_side: acc_target,
                point_value: acc_points,
                instruction_text: (acc_target===0 ? '左' : '右') + 'は' + acc_points + 'ポイント獲得',
                cycle_id: cycle
            };
            
            var inacc_trial = {
                condition_type: 'inaccurate',
                color: inacc_color,
                img_src: (inacc_color==='blue') ? IMG_BLUE_SRC : IMG_YELLOW_SRC,
                target_side: inacc_target,
                point_value: inacc_points,
                instruction_text: (inacc_target===0 ? '左' : '右') + 'は' + inacc_points + 'ポイント獲得',
                cycle_id: cycle
            };

            if(Math.random() < 0.5){ vars.push(acc_trial, inacc_trial); } 
            else { vars.push(inacc_trial, acc_trial); }
        }
        return vars;
    };

    var trial_index = 0;
    var training_vars_cache = null;

    var training_cue = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function(){
            var trial_data = training_vars_cache[trial_index];
            return `<div class="scene-container"><div class="character-box"><div class="speech-bubble">${trial_data.instruction_text}</div>${getImgHtml(trial_data.img_src)}</div></div>`;
        },
        choices: "NO_KEYS", trial_duration: 5000,
        on_start: function(){
            var trial_data = training_vars_cache[trial_index];
            block_start_time = Date.now();
            last_side = null;
            cod_triggered = false;
            current_phase = 'training';
            current_cycle = trial_data.cycle_id; 
            
            window.current_trial_params = trial_data;
            
            if(trial_data.condition_type === 'accurate'){
                next_reward_time = Date.now() + getNextInterval(VI_ACCURATE);
            } else {
                next_reward_time = 9999999999999;
            }
            document.getElementById('score-board').style.display = 'block';
        }
    };

    var training_controller = {
        timeline: [training_cue, choice_phase_loop, ici_block],
        loop_function: function(){
            trial_index++;
            if(trial_index < 8) return true; 
            return false;
        },
        on_timeline_start: function(){
            if(!training_vars_cache) {
                training_vars_cache = get_training_timeline_vars();
                trial_index = 0;
            }
        }
    };
    timeline.push(training_controller);

    var transition_screen = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `<div class="instruction-wrap"><h3>本番</h3><p>ここからはヒントを与える人物が2人同時に現れます。また獲得したポイント数は表示されません。</p><br></div>`,
        choices: ['次へ'],
        on_start: function(){ trial_index = 0; current_phase = 'test'; }
    };
    timeline.push(transition_screen);

    var get_test_vars = function(){
        var vars = [];
        var acc_color = experiment_data.accurate_color;
        var inacc_color = experiment_data.inaccurate_color;
        
        for(var cycle=0; cycle<4; cycle++){
            var acc_target = experiment_data.acc_pattern[cycle]; 
            var inacc_target = (acc_target === 0) ? 1 : 0; 
            var pos_acc = (Math.random() < 0.5) ? 'left' : 'right';

            vars.push({
                acc_color: acc_color,
                acc_text: (acc_target===0 ? '左' : '右') + 'は5ポイント獲得', 
                inacc_color: inacc_color,
                inacc_text: (inacc_target===0 ? '左' : '右') + 'は20ポイント獲得', 
                pos_acc: pos_acc, 
                acc_target: acc_target,
                cycle_id: cycle
            });
        }
        return vars;
    };
    
    var test_vars_cache = null;
    var test_cue = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function(){
            if(!test_vars_cache) test_vars_cache = get_test_vars();
            var d = test_vars_cache[trial_index];
            var img_acc = getImgHtml(d.acc_color==='blue' ? IMG_BLUE_SRC : IMG_YELLOW_SRC);
            var img_inacc = getImgHtml(d.inacc_color==='blue' ? IMG_BLUE_SRC : IMG_YELLOW_SRC);
            
            var left_guy = (d.pos_acc === 'left') ? { html: img_acc, text: d.acc_text } : { html: img_inacc, text: d.inacc_text };
            var right_guy = (d.pos_acc === 'left') ? { html: img_inacc, text: d.inacc_text } : { html: img_acc, text: d.acc_text };

            return `<div class="scene-container scene-wide-gap"><div class="character-box"><div class="speech-bubble">${left_guy.text}</div>${left_guy.html}</div><div class="character-box"><div class="speech-bubble">${right_guy.text}</div>${right_guy.html}</div></div><p style="font-size:20px; margin-top:20px;"></p>`;
        },
        choices: "NO_KEYS", trial_duration: 5000,
        on_start: function(){
            var d = test_vars_cache[trial_index];
            block_start_time = Date.now();
            last_side = null;
            cod_triggered = false;
            current_phase = 'test';
            current_cycle = d.cycle_id;
            window.current_trial_params = d;
            document.getElementById('score-board').style.display = 'none';
        }
    };
    var test_controller = {
        timeline: [test_cue, choice_phase_loop, ici_block],
        loop_function: function(){
            trial_index++;
            if(trial_index < 4) return true;
            return false;
        }
    };
    timeline.push(test_controller);

    var end_screen = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function(){
          var end_time = Date.now();
          var duration_minutes = ((end_time - experiment_start_timestamp) / 60000).toFixed(1);
          var total_money = test_points * 10;
          return `<div class="center-content"><h2>実験終了</h2><p>ご協力ありがとうございました。</p><p>所要時間: 約${duration_minutes}分</p><p>獲得金額: <span style="font-size:32px; color:red;">${total_money}円</span></p><p>（獲得ポイント: ${total_points} + 本番隠しポイント: ${test_points}）</p>
            <br><p>スペースキーを押してデータを送信・保存してください。</p></div>`;
      }
    };
    timeline.push(end_screen);

    jsPsych.run(timeline);
  </script>
</html>